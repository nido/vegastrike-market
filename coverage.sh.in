#!/bin/bash

find "@CMAKE_CURRENT_BINARY_DIR@" -iname "*.gcno" -exec rm -f {} \;

make clean
cmake "@CMAKE_SOURCE_DIR@" -D"CMAKE_CXX_FLAGS:string=-fprofile-arcs -ftest-coverage -DNDEBUG"


if test "@CMAKE_CURRENT_BINARY_DIR@" == @"CMAKE_CURRENT_BINARY_DIR"@
then
	echo "You are trying to execute a template, aint gonna do this for you, sorry"
	exit
fi

make

TESTCASES=$(ls "@CMAKE_SOURCE_DIR@/test/" | grep -Go ".*Test")

if test -n "$1"
then
TESTCASES="$1"
fi

for TEST in ${TESTCASES};
do
        lcov --quiet --rc lcov_branch_coverage=1 -z --directory "@CMAKE_CURRENT_BINARY_DIR@" -o coverage${TEST}.info
        ./cppunittest ${TEST}
        lcov --quiet --rc lcov_branch_coverage=1 -c -t ${TEST} --directory "@CMAKE_CURRENT_BINARY_DIR@" -o coverage${TEST}.info
        lcov --quiet --rc lcov_branch_coverage=1 -e coverage${TEST}.info "@CMAKE_CURRENT_SOURCE_DIR@/*" -o codecoverage${TEST}.info

done

lcov --quiet --rc lcov_branch_coverage=1 -o codecoverage.info -a codecoverage`echo ${TESTCASES} | sed "s/ /.info -a codecoverage/g"`.info

lcov --quiet --rc lcov_branch_coverage=1 -e codecoverage.info "@CMAKE_CURRENT_SOURCE_DIR@/src/*" -o coverage.info


genhtml --branch-coverage --legend --show-details --title "Vegastrike Economy" --demangle-cpp codecoverage.info --output-directory "@CMAKE_CURRENT_BINARY_DIR@/coverage/"

lcov --summary coverage.info 2>&1 | grep lines | grep -Go "[0-9]\+\.[0-9]%"

